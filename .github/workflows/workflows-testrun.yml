name: Workflow Test Run

on:
  workflow_dispatch:
    inputs:
      workflow_name:
        description: 'Specific workflow to test (leave empty to test all workflows)'
        required: false
        type: string
        default: ''
  pull_request:
    types: [opened, reopened, synchronize]
    paths:
      - 'workflows/**/*.wdl'
      - 'workflows/**/*.json'
      - '.github/workflows/workflows-testrun.yml'

permissions:
  contents: read

jobs:
  discover-workflows:
    runs-on: ubuntu-latest
    outputs:
      workflows: ${{ steps.find-workflows.outputs.workflows }}
    steps:
    -
      name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history for git diff
    -
      name: Find modified WDL workflows
      id: find-workflows
      run: python3 .github/scripts/discover_wdls.py workflows "${{ github.event.inputs.workflow_name }}"

  miniwdl-test:
    needs: [discover-workflows]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        workflow: ${{ fromJson(needs.discover-workflows.outputs.workflows) }}
      fail-fast: false
    steps:
    -
      name: Checkout
      uses: actions/checkout@v4
    -
      name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: 3.13
    -
      name: Install miniwdl
      run: |
        python -m pip install --upgrade pip
        pip3 install miniwdl
    -
      name: Run workflow with miniwdl
      run: |
        workflow_dir="workflows/${{ matrix.workflow }}"
        wdl_file="$workflow_dir/testrun.wdl"
        echo "Running ${{ matrix.workflow }} testrun with miniwdl..."
        miniwdl run "$wdl_file"

  cromwell-test:
    needs: [discover-workflows]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        workflow: ${{ fromJson(needs.discover-workflows.outputs.workflows) }}
      fail-fast: false
    steps:
    -
      name: Checkout
      uses: actions/checkout@v4
    -
      name: Set Up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
    -
      name: Download Cromwell
      run: |
        wget -q https://github.com/broadinstitute/cromwell/releases/download/86/cromwell-86.jar
    -
      name: Run workflow with Cromwell
      run: |
        workflow_dir="workflows/${{ matrix.workflow }}"
        wdl_file="$workflow_dir/testrun.wdl"
        echo "Running ${{ matrix.workflow }} testrun with Cromwell..."
        java -jar cromwell-86.jar run "$wdl_file"

  sprocket-test:
    needs: [discover-workflows]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        workflow: ${{ fromJson(needs.discover-workflows.outputs.workflows) }}
      fail-fast: false
    steps:
    -
      name: Checkout
      uses: actions/checkout@v4
    -
      name: Set Up Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
    -
      name: Install cargo-binstall
      run: curl -L --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash
    -
      name: Install Sprocket
      run: |
        cargo-binstall sprocket --version 0.15.0 -y
        cargo install --git https://github.com/getwilds/wdlparse --tag v0.0.5
    -
      name: Run workflow with Sprocket
      run: |
        workflow_dir="workflows/${{ matrix.workflow }}"
        wdl_file="$workflow_dir/testrun.wdl"
        # Extract entrypoint from the WDL file
        entrypoint=$(wdlparse parse --format json "$wdl_file" | jq -r '.wdl.workflows[].name')
        echo "Running ${{ matrix.workflow }} testrun with Sprocket using entrypoint: $entrypoint"
        sprocket run "$wdl_file" --entrypoint "$entrypoint"
