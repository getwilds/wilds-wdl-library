name: Reusable Test Run Workflow

on:
  workflow_call:
    inputs:
      item_type:
        description: 'Type to test (modules, vignettes, or workflows)'
        required: true
        type: string
      item_name:
        description: 'Specific item to test (leave empty to test all)'
        required: false
        type: string
        default: ''

permissions:
  contents: read

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      items: ${{ steps.find-items.outputs[inputs.item_type] }}
    steps:
    -
      name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history for git diff
    -
      name: Find items
      id: find-items
      run: python3 .github/scripts/discover_wdls.py ${{ inputs.item_type }} "${{ inputs.item_name }}"

  miniwdl-test:
    needs: [discover]
    # Test runs at the workflow level become difficult to run due to large collection 
    # of Docker images that need to be pulled down (see ww-leukemia for example).
    # Consider using larger runners in the future, e.g. ubuntu-latest-4-cores (4-core, 16GB RAM, 150GB disk)
    # https://docs.github.com/en/enterprise-cloud@latest/actions/concepts/runners/larger-runners
    runs-on: ubuntu-latest
    strategy:
      matrix:
        item: ${{ fromJson(needs.discover.outputs.items) }}
      fail-fast: false
    steps:
    -
      name: Checkout
      uses: actions/checkout@v4
    -
      name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: 3.13
    -
      name: Install miniwdl
      run: |
        python -m pip install --upgrade pip
        pip3 install miniwdl
    -
      name: Run workflow with miniwdl
      run: |
        item_dir="${{ inputs.item_type }}/${{ matrix.item }}"
        wdl_file="$item_dir/testrun.wdl"
        echo "Running ${{ inputs.item_type }}/${{ matrix.item }} with miniwdl..."
        miniwdl run "$wdl_file"

  cromwell-test:
    needs: [discover]
    # Test runs at the workflow level become difficult to run due to large collection 
    # of Docker images that need to be pulled down (see ww-leukemia for example).
    # Consider using larger runners in the future, e.g. ubuntu-latest-4-cores (4-core, 16GB RAM, 150GB disk)
    # https://docs.github.com/en/enterprise-cloud@latest/actions/concepts/runners/larger-runners
    runs-on: ubuntu-latest
    strategy:
      matrix:
        item: ${{ fromJson(needs.discover.outputs.items) }}
      fail-fast: false
    steps:
    -
      name: Checkout
      uses: actions/checkout@v4
    -
      name: Set Up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
    -
      name: Download Cromwell
      run: |
        wget -q https://github.com/broadinstitute/cromwell/releases/download/86/cromwell-86.jar
    -
      name: Run workflow with Cromwell
      run: |
        item_dir="${{ inputs.item_type }}/${{ matrix.item }}"
        wdl_file="$item_dir/testrun.wdl"
        echo "Running ${{ inputs.item_type }}/${{ matrix.item }} with Cromwell..."
        java -jar cromwell-86.jar run "$wdl_file"

  sprocket-test:
    needs: [discover]
    # Test runs at the workflow level become difficult to run due to large collection 
    # of Docker images that need to be pulled down (see ww-leukemia for example).
    # Consider using larger runners in the future, e.g. ubuntu-latest-4-cores (4-core, 16GB RAM, 150GB disk)
    # https://docs.github.com/en/enterprise-cloud@latest/actions/concepts/runners/larger-runners
    runs-on: ubuntu-latest
    strategy:
      matrix:
        item: ${{ fromJson(needs.discover.outputs.items) }}
      fail-fast: false
    steps:
    -
      name: Checkout
      uses: actions/checkout@v4
    -
      name: Set Up Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
    -
      name: Install cargo-binstall
      run: curl -L --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash
    -
      name: Install Sprocket
      run: |
        cargo-binstall sprocket --version 0.15.0 -y
        cargo install --git https://github.com/getwilds/wdlparse --tag v0.0.5
    -
      name: Run workflow with Sprocket
      run: |
        item_dir="${{ inputs.item_type }}/${{ matrix.item }}"
        wdl_file="$item_dir/testrun.wdl"
        # Extract entrypoint from the WDL file
        entrypoint=$(wdlparse parse --format json "$wdl_file" | jq -r '.wdl.workflows[].name')
        echo "Running ${{ inputs.item_type }}/${{ matrix.item }} with Sprocket using entrypoint: $entrypoint"
        sprocket run "$wdl_file" --entrypoint "$entrypoint"
